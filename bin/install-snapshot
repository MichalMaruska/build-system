#! /bin/bash -eux

# This is just a wrapper around dput.

# Given as $1 the changes file
# dput it to all in MBS_SNAP_TARGETS.




function usage(){
cat <<EOF
usage: ${0##*/} [+-uf} [--] ARGS...
dput(1) options basically
-u don't check the signaure
-f force RE-upload
EOF
}

# make it invokable ...
DPUT_OPTIONS=""
while getopts :uf OPT; do
    case $OPT in
	u|+u)
	    DPUT_OPTIONS+="--unchecked "
	    ;;
	f)
	    DPUT_OPTIONS+="--force "
	    ;;

	*)
	    usage
	    exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

if [ $# -gt 0 ]
then
    GBP_CHANGES_FILE=$1
    GBP_BUILD_DIR="/"
fi



# $GBP_BUILD_DIR is the build directory: I don't need it.
cecho green "putting into repositories: $GBP_CHANGES_FILE"

if [ -n "${REPREPRO_BASE_DIR:-}" ]
then
    # fixme: snapshot -> not a big deal if I still get the dist. wrong?
    # --basedir ~/reprepro/
    reprepro --ignore=wrongdistribution  -V \
        include UNRELEASED $GBP_CHANGES_FILE
else
    for TARGET in ${MBS_SNAP_TARGETS-local}
    do
	dput $DPUT_OPTIONS $TARGET $GBP_CHANGES_FILE
    done
fi

# this is even faster:
if [ ${INSTALL_IMMEDIATELY:-n} = "y" ]
then
    cecho green "installing immediately $GBP_CHANGES_FILE"
    debi --upgrade $GBP_CHANGES_FILE
fi
